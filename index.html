<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Keuangan Pribadi</title>

    <!-- Bulma CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF & AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --color-primary: #1167b1;
            --color-secondary: #187bcd;
            --color-info: #2a9df4;
            --color-dark-bg: #03254c;
            --color-darker: #0e2433;
            --color-light: #d0efff;
            --text-main: #363636;
            --bg-main: #fcfcfc;
            --card-bg: #ffffff;

            /* Light Mode Table Colors */
            --row-even: #f0f8ff;
            --row-odd: #ffffff;
            --modal-content-bg: #ffffff;
            --modal-head-foot-bg: #f5f5f5;

            --input-bg: #ffffff;
            --input-border: #dbdbdb;
            --input-text: #363636;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --text-main: #e0e0e0;
            --bg-main: #0b1a26;
            --card-bg: #03254c;

            /* Dark Mode Table Colors */
            --row-even: #0a3d6b;
            --row-odd: #052c52;

            --modal-content-bg: #03254c;
            --modal-head-foot-bg: #021a36;

            --input-bg: #06386e;
            --input-border: #2a9df4;
            --input-text: #ffffff;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Layout */
        .main-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 260px;
            background-color: var(--color-dark-bg);
            color: white;
            padding: 2rem 1rem;
            position: fixed;
            height: 100vh;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 1000;
            left: 0;
            top: 0;
        }

        .sidebar .menu-label {
            color: #8bbce7;
        }

        .sidebar .menu-list a {
            color: #d0efff;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar .menu-list a:hover,
        .sidebar .menu-list a.is-active {
            background-color: var(--color-primary);
            color: white;
        }

        .content-area {
            flex: 1;
            margin-left: 260px;
            padding: 2rem;
            position: relative;
            overflow-x: hidden;
            width: 100%;
        }

        /* --- COMPLEX ANIMATED BURGER MENU (CSS ONLY) --- */
        .burger-menu {
            display: none;
            /* Hidden on Desktop */
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 2000;
            /* Higher than sidebar */
            width: 30px;
            height: 20px;
            cursor: pointer;
            background: transparent;
            border: none;
            padding: 0;
            flex-direction: column;
            justify-content: space-between;
        }

        .burger-menu span {
            display: block;
            width: 100%;
            height: 3px;
            background-color: var(--color-primary);
            border-radius: 4px;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            /* Complex Easing */
            transform-origin: center;
        }

        /* Active State (X Animation) */
        .burger-menu.is-active span:nth-child(1) {
            transform: translateY(8.5px) rotate(45deg);
        }

        .burger-menu.is-active span:nth-child(2) {
            opacity: 0;
            transform: scale(0);
            /* Shrink effect */
        }

        .burger-menu.is-active span:nth-child(3) {
            transform: translateY(-8.5px) rotate(-45deg);
        }

        /* Responsive Sidebar Logic */
        @media (max-width: 1023px) {
            .sidebar {
                transform: translateX(-100%);
                /* Slide from Left */
                width: 260px;
                /* Standard drawer width */
                box-shadow: 4px 0 15px rgba(0, 0, 0, 0.3);
                padding-top: 6rem;
                /* Space for X button */
                text-align: left;
                /* Align Left */
            }

            .sidebar.is-active {
                transform: translateX(0);
            }

            .sidebar .menu-list a {
                justify-content: flex-start;
                /* Items align left */
                padding-left: 1rem;
            }

            .content-area {
                margin-left: 0;
                padding-top: 5rem;
                padding-left: 1rem;
                padding-right: 1rem;
            }

            .burger-menu {
                display: flex;
                /* Show on mobile/tablet */
            }
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 1.5rem;
            right: 2rem;
            z-index: 1001;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--color-primary);
            background: var(--card-bg);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        /* Components */
        .card {
            background-color: var(--card-bg);
            color: var(--text-main);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
            position: relative;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        /* FIX: Apply text color globally to all titles, subtitles, and labels to override Bulma defaults */
        .title,
        .subtitle,
        .label {
            color: var(--text-main) !important;
        }

        /* Input Styles */
        .input,
        .select select,
        .textarea {
            background-color: var(--input-bg);
            border-color: var(--input-border);
            color: var(--input-text);
        }

        .input::placeholder,
        .textarea::placeholder {
            color: #888;
        }

        body.dark-mode .select:not(.is-multiple):not(.is-loading)::after {
            border-color: var(--color-primary);
        }

        /* Tables & Scrolling - FIXED */
        .table-responsive-wrapper {
            display: block;
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 1rem;
            border-radius: 8px;
            border: 1px solid var(--input-border);
        }

        table.table {
            background-color: var(--card-bg);
            color: var(--text-main);
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        table.table th {
            color: var(--text-main);
            background-color: var(--color-primary);
            color: white !important;
            border: none;
            white-space: nowrap;
        }

        table.table td {
            border: none;
            vertical-align: middle;
            color: var(--text-main);
            padding: 0.75rem;
        }

        table.table tbody tr:nth-child(odd) {
            background-color: var(--row-odd);
        }

        table.table tbody tr:nth-child(even) {
            background-color: var(--row-even);
        }

        .col-desc {
            min-width: 200px;
            max-width: 300px;
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
        }

        /* Icon Buttons */
        .top-right-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 5px;
            font-size: 1.2rem;
        }

        /* Custom Colors */
        .has-text-success-custom {
            color: #2ecc71;
        }

        .has-text-danger-custom {
            color: #e74c3c;
        }

        /* NEW: Custom Color for Transfer */
        .has-text-info-custom {
            color: #3e8ed0; /* Bulma info blue or similar */
        }

        .saldo-card {
            background: linear-gradient(135deg, var(--color-dark-bg), var(--color-primary));
            color: white !important;
        }

        .saldo-card .title,
        .saldo-card .subtitle {
            color: white !important;
        }

        /* Tabs Vertical */
        .tabs-vertical-container {
            display: grid;
            grid-template-columns: 220px minmax(0, 1fr);
            gap: 1.5rem;
            width: 100%;
        }

        @media (max-width: 768px) {
            .tabs-vertical-container {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        .vertical-tabs a {
            display: block;
            padding: 12px 15px;
            background: var(--card-bg);
            margin-bottom: 5px;
            border-radius: 6px;
            border-left: 4px solid transparent;
            cursor: pointer;
            color: var(--text-main);
            transition: background 0.2s;
        }

        .vertical-tabs a:hover {
            background-color: var(--row-even);
        }

        .vertical-tabs a.is-active {
            border-left-color: var(--color-primary);
            background: var(--row-even);
            font-weight: bold;
            color: var(--color-primary);
        }

        /* Modal */
        .modal-card-head,
        .modal-card-foot {
            background-color: var(--modal-head-foot-bg);
            border-color: var(--input-border);
        }

        .modal-card-title {
            color: var(--text-main);
        }

        .modal-card-body {
            background-color: var(--modal-content-bg);
            color: var(--text-main);
        }

        .modal-card-foot {
            justify-content: flex-end;
        }

        /* Summary Text */
        .summary-text-block {
            background: var(--row-even);
            border-left: 4px solid var(--color-primary);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.95rem;
            color: var(--text-main);
        }

        .summary-text-block p {
            margin-bottom: 4px;
        }

        /* Toggle Buttons */
        .toggle-btn-group .button {
            border: 1px solid var(--input-border);
            color: var(--text-main);
            background-color: var(--card-bg);
        }

        .toggle-btn-group .button.is-selected-success {
            background-color: #2ecc71;
            color: white;
            border-color: #2ecc71;
            z-index: 2;
        }

        .toggle-btn-group .button.is-selected-danger {
            background-color: #e74c3c;
            color: white;
            border-color: #e74c3c;
            z-index: 2;
        }

        .button.is-sort-active {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* === CAROUSEL STYLES (DASHBOARD & SIDEBAR) === */
        .carousel-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .carousel-viewport {
            overflow: hidden;
            width: 100%;
            padding: 8px 0; 
        }
        .carousel-track {
            display: flex;
            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            width: 100%;
        }
        .carousel-slide {
            min-width: 100%;
            box-sizing: border-box;
            padding: 0 4px; 
        }
        
        /* Unified Carousel Buttons Layout & Design */
        .sidebar-carousel-controls, 
        .dashboard-carousel-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem; /* Space between buttons */
            margin-bottom: 1.25rem;
            width: 100%;
            padding: 0 4px; /* Slight padding to align */
        }

        /* Custom Style for Carousel Buttons (Adaptive Theme) */
        .sidebar-carousel-controls .button,
        .dashboard-carousel-controls .button {
            background-color: var(--card-bg); /* White in Light, Dark Blue in Dark */
            border: 1px solid var(--input-border);
            color: var(--text-main);
            transition: all 0.3s ease;
            height: 2.2em; /* Compact height */
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Hover State - Active Glow */
        .sidebar-carousel-controls .button:hover:not(:disabled),
        .dashboard-carousel-controls .button:hover:not(:disabled) {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: #fff;
            box-shadow: 0 4px 12px rgba(17, 103, 177, 0.4); /* Glow effect */
            transform: translateY(-2px);
        }

        /* Active Click State */
        .sidebar-carousel-controls .button:active:not(:disabled),
        .dashboard-carousel-controls .button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Disabled State - Dimmed and Locked */
        .sidebar-carousel-controls .button:disabled,
        .dashboard-carousel-controls .button:disabled {
            background-color: var(--input-bg);
            border-color: var(--input-border);
            color: var(--text-main);
            cursor: not-allowed;
            opacity: 0.4;
            box-shadow: none;
        }

        /* Dots Indicator */
        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 2rem;
        }
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--input-border);
            cursor: pointer;
            transition: all 0.3s;
        }
        .dot.is-active {
            background-color: var(--color-primary);
            width: 24px;
            border-radius: 4px;
        }

        /* Utilities */
        .is-hidden {
            display: none !important;
        }

        .is-vcentered {
            display: flex;
            align-items: center;
        }
    </style>
</head>

<body>

    <!-- Theme Toggle -->
    <div class="theme-toggle" onclick="toggleTheme()" title="Ganti Tema">
        <i class="ph ph-moon" id="theme-icon"></i>
    </div>

    <!-- Animated Burger Menu -->
    <div class="burger-menu" onclick="toggleSidebar()" aria-label="Toggle Menu">
        <span></span>
        <span></span>
        <span></span>
    </div>

    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <p class="menu-label pl-4">Aplikasi Keuangan</p>
            <ul class="menu-list">
                <li><a onclick="navigate('dashboard')" id="nav-dashboard" class="is-active"><i
                            class="ph ph-squares-four"></i> Dashboard</a></li>
                <li><a onclick="navigate('catatan')" id="nav-catatan"><i class="ph ph-notebook"></i> Catatan
                        Transaksi</a></li>
                <li><a onclick="navigate('penyimpanan')" id="nav-penyimpanan"><i class="ph ph-dresser"></i>
                        Penyimpanan</a></li>
                <li><a onclick="navigate('transfer')" id="nav-transfer"><i class="ph ph-arrows-left-right"></i>
                        Transfer</a></li>
            </ul>
        </aside>

        <!-- Content Area -->
        <main class="content-area">

            <!-- PAGE: DASHBOARD -->
            <div id="page-dashboard">
                <h1 class="title is-4 mb-5">Dashboard</h1>

                <!-- Summary Cards -->
                <div class="columns">
                    <div class="column is-6">
                        <div class="card p-4">
                            <div class="is-flex is-align-items-center" style="height: 100%;">
                                <div class="mr-4">
                                    <i class="ph ph-trend-up has-text-success-custom is-size-3"></i>
                                </div>
                                <div>
                                    <p class="heading has-text-success-custom mb-0"><b>Pemasukan Bulanan</b></p>
                                    <p class="title is-5 has-text-success-custom mt-1" id="dash-pemasukan">Rp 0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="column is-6">
                        <div class="card p-4">
                            <div class="is-flex is-align-items-center" style="height: 100%;">
                                <div class="mr-4">
                                    <i class="ph ph-trend-down has-text-danger-custom is-size-3"></i>
                                </div>
                                <div>
                                    <p class="heading has-text-danger-custom mb-0"><b>Pengeluaran Bulanan</b></p>
                                    <p class="title is-5 has-text-danger-custom mt-1" id="dash-pengeluaran">Rp 0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card saldo-card p-5 mb-5 ">
                    <div class="center-left-actions is-flex is-align-items-center">
                        <i class="ph ph-wallet mr-4" style="font-size: 2rem;"></i>
                        <div>
                            <p class="heading">Total Uang Seluruh Penyimpanan</p>
                            <p class="title is-3" id="dash-total-uang">Rp 0</p>
                        </div>
                    </div>

                </div>

                <!-- Storage Details Cards (New Carousel Layout) -->
                <div id="storage-carousel-wrapper" class="carousel-wrapper">
                    <div class="carousel-viewport">
                        <div id="dash-storage-track" class="carousel-track">
                            <!-- Slides will be injected here via JS -->
                        </div>
                    </div>
                </div>

                <!-- Dashboard Navigation Buttons (New Grid Layout) -->
                <div class="dashboard-carousel-controls">
                    <button class="button is-small" id="dash-prev-btn" onclick="prevSlide()">
                        <i class="ph ph-caret-left"></i>
                    </button>
                    <button class="button is-small" id="dash-next-btn" onclick="nextSlide()">
                        <i class="ph ph-caret-right"></i>
                    </button>
                </div>

                <!-- Pagination Dots -->
                <div class="carousel-dots" id="carousel-dots"></div>


                <!-- Chart -->
                <div class="card p-4">
                    <div class="level is-mobile mb-2">
                        <div class="level-left">
                            <p class="title is-5">Analisa Keuangan (Bulan Ini)</p>
                        </div>
                        <div class="level-right">
                            <button class="button is-small is-ghost" onclick="downloadChartPDF()"><i
                                    class="ph ph-download-simple is-size-5"></i></button>
                        </div>
                    </div>
                    <div style="position: relative; height:300px; width:100%">
                        <canvas id="financeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- PAGE: CATATAN -->
            <div id="page-catatan" class="is-hidden">
                <h1 class="title is-4 mb-5">Catatan Transaksi</h1>

                <!-- Form -->
                <div class="card p-5 mb-5">

                    <form id="form-transaksi" onsubmit="handleTransactionSubmit(event)">
                        <div class="columns is-multiline">
                            <div class="column is-6">
                                <div class="field">
                                    <label class="label">Tanggal</label>
                                    <div class="control">
                                        <input class="input" type="date" id="trx-date" required>
                                    </div>
                                </div>
                            </div>
                            <div class="column is-6">
                                <div class="field">
                                    <label class="label">Penyimpanan</label>
                                    <div class="control">
                                        <div class="select is-fullwidth">
                                            <select id="trx-storage" required>
                                                <option value="" disabled selected>Pilih Penyimpanan</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="column is-12">
                                <div class="field">
                                    <label class="label">Jenis Transaksi</label>
                                    <div class="control toggle-btn-group">
                                        <div class="buttons has-addons is-fullwidth">
                                            <button type="button" class="button is-fullwidth is-selected-success"
                                                id="btn-in" onclick="setTrxType('Pemasukan')"><b>Pemasukan</b></button>
                                            <button type="button" class="button is-fullwidth" id="btn-out"
                                                onclick="setTrxType('Pengeluaran')"><b>Pengeluaran</b></button>
                                        </div>
                                        <input type="hidden" name="trx-type" id="trx-type-input" value="Pemasukan">
                                    </div>
                                </div>
                            </div>
                            <div class="column is-12">
                                <div class="field">
                                    <label class="label">Nominal Rupiah</label>
                                    <div class="control has-icons-left">
                                        <input class="input" type="text" id="trx-amount" inputmode="numeric"
                                            placeholder="0" required onkeyup="formatCurrencyInput(this)">
                                        <span class="icon is-small is-left">Rp</span>
                                    </div>
                                </div>
                            </div>
                            <div class="column is-12">
                                <div class="field">
                                    <label class="label">Catatan Deskripsi</label>
                                    <div class="control">
                                        <textarea class="textarea" id="trx-desc" placeholder="Keterangan transaksi..."
                                            required rows="2"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="buttons is-right">
                            <button type="submit" class="button is-primary"><i class="ph ph-plus mr-1"></i>
                                Tambah</button>
                            <button type="button" class="button is-light" onclick="resetForm('form-transaksi')"><i
                                    class="ph ph-arrow-counter-clockwise mr-1"></i> Reset</button>
                            <button type="button" class="button is-warning" onclick="deleteLastTransaction()"><i
                                    class="ph ph-backspace mr-1"></i> Hapus Terakhir</button>
                            <button type="button" class="button is-danger" onclick="deleteAllData()"><i
                                    class="ph ph-trash mr-1"></i> Hapus Semua Data</button>
                        </div>
                    </form>
                </div>

                <!-- Summary Stats -->
                <div class="summary-text-block" id="summary-stats-catatan"></div>

                <!-- Filters & Table Actions -->
                <div class="level is-multiline mb-3" style="flex-wrap: wrap; gap: 10px;">
                    <div class="level-left">
                        <p class="subtitle is-5 font-weight-bold" id="table-period-label">Data Bulan Ini</p>
                    </div>
                    <div class="level-right">
                        <div class="buttons are-medium">
                            <button class="button is-info is-light is-medium" id="sort-asc-btn"
                                onclick="sortData('asc', 'table-keuangan')" title="Ascending"><i
                                    class="ph ph-arrow-up"></i></button>
                            <button class="button is-info is-light is-medium" id="sort-desc-btn"
                                onclick="sortData('desc', 'table-keuangan')" title="Descending"><i
                                    class="ph ph-arrow-down"></i></button>

                            <button class="button is-info is-light is-medium" onclick="openModal('modal-range')"
                                title="Rentang Riwayat"><i class="ph ph-calendar-plus"></i></button>
                            <button class="button is-info is-light is-medium" onclick="openModal('modal-monthly')"
                                title="Riwayat Bulanan"><i class="ph ph-calendar"></i></button>
                            <button class="button is-info is-light is-medium" onclick="openModal('modal-yearly')"
                                title="Riwayat Tahunan"><i class="ph ph-calendar-blank"></i></button>
                            <button class="button is-link is-medium"
                                onclick="downloadPDF('table-keuangan', 'Catatan Transaksi')"
                                title="Unduh PDF Landscape"><i class="ph ph-file-pdf"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-container table-responsive-wrapper">
                    <table class="table is-fullwidth" id="table-keuangan">
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Penyimpanan</th>
                                <th>Transaksi</th>
                                <th class="col-desc">Deskripsi</th>
                                <th class="has-text-right">Saldo</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-keuangan"></tbody>
                    </table>
                </div>
            </div>

            <!-- PAGE: PENYIMPANAN -->
            <div id="page-penyimpanan" class="is-hidden">
                <h1 class="title is-4 mb-5">Manajemen Penyimpanan</h1>

                <div class="tabs-vertical-container">
                    <!-- Left: Navigation / List -->
                    <div class="vertical-tabs" id="storage-tabs">
                        <!-- Static 'All' Button -->
                        <a class="is-active mb-3" onclick="switchStorageTab('all')" style="border-bottom: 2px solid var(--input-border);"><b>Daftar Penyimpanan</b></a>
                        
                        <!-- Storage List Carousel (Vertical Items, Horizontal Slide) -->
                        <div id="nav-carousel-wrapper" class="carousel-wrapper" style="margin-bottom: 0.5rem;">
                            <div class="carousel-viewport">
                                <div id="nav-storage-track" class="carousel-track">
                                    <!-- Slides of storage items injected here -->
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Buttons (External Grid) -->
                        <div class="sidebar-carousel-controls">
                            <button class="button is-small" id="nav-prev-btn" onclick="prevNavSlide()">
                                <i class="ph ph-caret-left"></i>
                            </button>
                            <button class="button is-small" id="nav-next-btn" onclick="nextNavSlide()">
                                <i class="ph ph-caret-right"></i>
                            </button>
                        </div>

                        <div class="carousel-dots" id="nav-carousel-dots" style="margin-bottom: 1rem;"></div>
                    </div>

                    <!-- Right: Content -->
                    <div class="storage-content">
                        <!-- Content for 'all' -->
                        <div id="storage-view-all">
                            <button class="button is-primary mb-4" onclick="openModal('modal-add-storage')">
                                <i class="ph ph-plus-circle mr-2"></i> Tambah Simpanan
                            </button>

                            <div class="table-container table-responsive-wrapper">
                                <table class="table is-fullwidth" id="table-penyimpanan-list">
                                    <thead>
                                        <tr>
                                            <th>Aksi</th>
                                            <th>Penyimpanan</th>
                                            <th class="has-text-right">Total Saldo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-penyimpanan-list"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Content for specific storage -->
                        <div id="storage-view-detail" class="is-hidden">
                            <div class="card p-4 mb-4"
                                style="background: linear-gradient(135deg, var(--color-primary), var(--color-info)); color: white;">
                                <p class="is-size-7" style="color: #e0f2ff;">Total Saldo Saat Ini</p>
                                <p class="title is-3" style="color: white;" id="detail-storage-balance">Rp 0</p>
                            </div>

                            <div class="summary-text-block" id="summary-stats-storage"></div>

                            <!-- IMPROVED BUTTON LAYOUT FOR STORAGE DETAIL -->
                            <div class="level is-multiline mb-3" style="flex-wrap: wrap; gap: 10px;">
                                <div class="level-left">
                                    <h2 class="subtitle is-5" id="detail-storage-name">Nama Simpanan</h2>
                                </div>
                                <div class="level-right">
                                    <div class="buttons are-medium">
                                        <button class="button is-info is-light is-medium" id="sort-asc-storage"
                                            onclick="sortData('asc', 'table-storage-detail')"><i
                                                class="ph ph-arrow-up"></i></button>
                                        <button class="button is-info is-light is-medium" id="sort-desc-storage"
                                            onclick="sortData('desc', 'table-storage-detail')"><i
                                                class="ph ph-arrow-down"></i></button>

                                        <button class="button is-info is-light is-medium"
                                            onclick="openModal('modal-range')" title="Rentang"><i
                                                class="ph ph-calendar-plus"></i></button>
                                        <button class="button is-info is-light is-medium"
                                            onclick="openModal('modal-monthly')" title="Bulanan"><i
                                                class="ph ph-calendar"></i></button>
                                        <button class="button is-info is-light is-medium"
                                            onclick="openModal('modal-yearly')" title="Tahunan"><i
                                                class="ph ph-calendar-blank"></i></button>
                                        <button class="button is-link is-medium" onclick="downloadStoragePDF()"
                                            title="PDF Landscape"><i class="ph ph-file-pdf"></i></button>
                                    </div>
                                </div>
                            </div>

                            <div class="table-container table-responsive-wrapper">
                                <table class="table is-fullwidth" id="table-storage-detail">
                                    <thead>
                                        <tr>
                                            <th>Tanggal</th>
                                            <th>Transaksi</th>
                                            <th class="col-desc">Deskripsi</th>
                                            <th class="has-text-right">Saldo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-storage-detail"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PAGE: TRANSFER -->
            <div id="page-transfer" class="is-hidden">
                <h1 class="title is-4 mb-5">Transfer Antar Penyimpanan</h1>

                <div class="card p-5">

                    <form id="form-transfer" onsubmit="handleTransferSubmit(event)">
                        <div class="columns is-multiline">
                            <div class="column is-12">
                                <div class="field">
                                    <label class="label">Tanggal Transfer</label>
                                    <div class="control">
                                        <input class="input" type="date" id="trf-date" required>
                                    </div>
                                </div>
                            </div>
                            <div class="column is-6">
                                <div class="field">
                                    <label class="label">ðŸ“¤â”‚Dari Sumber Penyimpanan</label>
                                    <div class="control">
                                        <div class="select is-fullwidth">
                                            <select id="trf-source" required>
                                                <option value="" disabled selected>Pilih Sumber</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="column is-6">
                                <div class="field">
                                    <label class="label">ðŸ“¥â”‚Ke Tujuan Penyimpanan</label>
                                    <div class="control">
                                        <div class="select is-fullwidth">
                                            <select id="trf-dest" required>
                                                <option value="" disabled selected>Pilih Tujuan</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="column is-12">
                                <div class="field">
                                    <label class="label">Nominal Transfer (Rp)</label>
                                    <div class="control has-icons-left">
                                        <input class="input" type="text" id="trf-amount" inputmode="numeric"
                                            placeholder="0" required onkeyup="formatCurrencyInput(this)">
                                        <span class="icon is-small is-left">Rp</span>
                                    </div>
                                </div>
                            </div>
                            <div class="column is-6">
                                <div class="field">
                                    <label class="label">Catatan Sumber Penyimpanan</label>
                                    <div class="control">
                                        <textarea class="textarea" id="trf-desc-source" rows="2"
                                            placeholder="Ex: Transfer ke..." required></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="column is-6">
                                <div class="field">
                                    <label class="label">Catatan Tujuan Penyimpanan</label>
                                    <div class="control">
                                        <textarea class="textarea" id="trf-desc-dest" rows="2"
                                            placeholder="Ex: Transfer dari..." required></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="buttons is-right">
                            <button type="submit" class="button is-primary"><i class="ph ph-paper-plane-right mr-2"></i>
                                Kirim Uang</button>
                        </div>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <!-- MODALS -->

    <!-- Modal Rentang -->
    <div class="modal" id="modal-range">
        <div class="modal-background" onclick="closeModal('modal-range')"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Filter Rentang Waktu</p>
                <button class="delete" aria-label="close" onclick="closeModal('modal-range')"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Dari Tanggal</label>
                    <input class="input" type="date" id="filter-start">
                </div>
                <div class="field">
                    <label class="label">Sampai Tanggal</label>
                    <input class="input" type="date" id="filter-end">
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button" onclick="closeModal('modal-range')">Batal</button>
                <button class="button is-success" onclick="applyFilter('range')">Ok</button>
            </footer>
        </div>
    </div>

    <!-- Modal Bulanan -->
    <div class="modal" id="modal-monthly">
        <div class="modal-background" onclick="closeModal('modal-monthly')"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Filter Bulanan</p>
                <button class="delete" aria-label="close" onclick="closeModal('modal-monthly')"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Bulan</label>
                    <div class="select is-fullwidth">
                        <select id="filter-month-select">
                            <option value="1">Januari</option>
                            <option value="2">Februari</option>
                            <option value="3">Maret</option>
                            <option value="4">April</option>
                            <option value="5">Mei</option>
                            <option value="6">Juni</option>
                            <option value="7">Juli</option>
                            <option value="8">Agustus</option>
                            <option value="9">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Desember</option>
                        </select>
                    </div>
                </div>
                <div class="field">
                    <label class="label">Tahun</label>
                    <input class="input" type="text" inputmode="numeric" id="filter-month-year" placeholder="YYYY">
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button" onclick="closeModal('modal-monthly')">Batal</button>
                <button class="button is-success" onclick="applyFilter('monthly')">Ok</button>
            </footer>
        </div>
    </div>

    <!-- Modal Tahunan -->
    <div class="modal" id="modal-yearly">
        <div class="modal-background" onclick="closeModal('modal-yearly')"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Filter Tahunan</p>
                <button class="delete" aria-label="close" onclick="closeModal('modal-yearly')"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Tahun</label>
                    <input class="input" type="text" inputmode="numeric" id="filter-year-input" placeholder="YYYY">
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button" onclick="closeModal('modal-yearly')">Batal</button>
                <button class="button is-success" onclick="applyFilter('yearly')">Ok</button>
            </footer>
        </div>
    </div>

    <!-- Modal Tambah Penyimpanan -->
    <div class="modal" id="modal-add-storage">
        <div class="modal-background" onclick="closeModal('modal-add-storage')"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Tambah Penyimpanan Baru</p>
                <button class="delete" aria-label="close" onclick="closeModal('modal-add-storage')"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Nama Penyimpanan</label>
                    <input class="input" type="text" id="new-storage-name" placeholder="Masukan Nama Penyimpanan">
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button" onclick="closeModal('modal-add-storage')">Batal</button>
                <button class="button is-success" onclick="saveNewStorage()">Simpan</button>
            </footer>
        </div>
    </div>

    <!-- Modal Edit Penyimpanan -->
    <div class="modal" id="modal-edit-storage">
        <div class="modal-background" onclick="closeModal('modal-edit-storage')"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Edit Nama Penyimpanan</p>
                <button class="delete" aria-label="close" onclick="closeModal('modal-edit-storage')"></button>
            </header>
            <section class="modal-card-body">
                <input type="hidden" id="edit-storage-id">
                <div class="field">
                    <label class="label">Nama Baru</label>
                    <input class="input" type="text" id="edit-storage-name">
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button" onclick="closeModal('modal-edit-storage')">Batal</button>
                <button class="button is-success" onclick="saveEditStorage()">Update</button>
            </footer>
        </div>
    </div>


    <script>

        // --- 1. SUPABASE CONFIGURATION ---
        const SUPABASE_URL = 'https://gscsuzovbuvckkwukiky.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdzY3N1em92YnV2Y2trd3VraWt5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzcwMjQsImV4cCI6MjA3OTY1MzAyNH0.SyYeUFXJ0MKx_2d5EWoM3W4pqQUomWeqxOsfSwApdz4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. GLOBAL STATE ---
        let currentStorageTabId = null;
        let currentStorageName = "";
        let currentStorageBalance = 0;
        let chartInstance = null;
        let activeFilter = { type: 'currentMonth' };
        let storageMap = {};
        let summaryStats = { mIn: 0, mOut: 0, yIn: 0, yOut: 0 };

        // Dashboard Carousel State
        let currentSlide = 0;
        let cachedStorageBalances = {};

        // Sidebar Navigation Carousel State
        let currentNavSlide = 0;
        let navStorageItems = [];

        // --- 3. UI HELPERS & THEME ---
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });

        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-icon').classList.replace('ph-moon', 'ph-sun');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('theme-icon');
            if (document.body.classList.contains('dark-mode')) {
                icon.classList.replace('ph-moon', 'ph-sun');
                localStorage.setItem('theme', 'dark');
            } else {
                icon.classList.replace('ph-sun', 'ph-moon');
                localStorage.setItem('theme', 'light');
            }
            if (chartInstance) updateChartColors();
        }

        // Toggle Sidebar Function
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('is-active');
            document.querySelector('.burger-menu').classList.toggle('is-active');
        }

        // Toggle Buttons Logic (Radio Replacement)
        function setTrxType(type) {
            document.getElementById('trx-type-input').value = type;
            const btnIn = document.getElementById('btn-in');
            const btnOut = document.getElementById('btn-out');

            // Reset
            btnIn.classList.remove('is-selected-success');
            btnOut.classList.remove('is-selected-danger');
            btnIn.classList.remove('is-selected');
            btnOut.classList.remove('is-selected');

            if (type === 'Pemasukan') {
                btnIn.classList.add('is-selected-success');
            } else {
                btnOut.classList.add('is-selected-danger');
            }
        }

        // --- 4. NAVIGATION & INIT ---
        function navigate(page) {
            document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('is-hidden'));
            document.querySelectorAll('.menu-list a').forEach(el => el.classList.remove('is-active'));
            document.getElementById(`page-${page}`).classList.remove('is-hidden');
            document.getElementById(`nav-${page}`).classList.add('is-active');

            // Auto close sidebar on mobile when link is clicked
            if (window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.remove('is-active');
                document.querySelector('.burger-menu').classList.remove('is-active');
            }

            if (page === 'dashboard') loadDashboard();
            if (page === 'catatan') loadCatatan();
            if (page === 'penyimpanan') loadPenyimpanan();
            if (page === 'transfer') loadTransfer();
        }

        window.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('trx-date').value = today;
            document.getElementById('trf-date').value = today;
            loadDashboard();
            
            // Resize listener for Carousel responsiveness
            window.addEventListener('resize', () => {
                if(!document.getElementById('page-dashboard').classList.contains('is-hidden')) {
                    initDashboardCarousel();
                }
            });
        });

        // --- 5. DATA FORMATTING & UTILS ---
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        }

        function unformatRupiah(str) {
            return parseInt(str.replace(/[^0-9]/g, '')) || 0;
        }

        function formatCurrencyInput(input) {
            let val = input.value.replace(/[^0-9]/g, '');
            if (val === '') { input.value = ''; return; }
            input.value = new Intl.NumberFormat('id-ID').format(val);
        }

        function formatDate(dateStr) {
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return new Date(dateStr).toLocaleDateString('id-ID', options);
        }

        // Helper to get strictly formatted YYYY-MM-DD strings for filters
        function getMonthDateRange(year, month) {
            // Month is 1-12
            const startStr = `${year}-${String(month).padStart(2, '0')}-01`;
            const lastDay = new Date(year, month, 0).getDate();
            const endStr = `${year}-${String(month).padStart(2, '0')}-${lastDay}`;
            return { start: startStr, end: endStr };
        }

        function getCurrentMonthRange() {
            const now = new Date();
            return getMonthDateRange(now.getFullYear(), now.getMonth() + 1);
        }

        function getYearRange(year) {
            return { start: `${year}-01-01`, end: `${year}-12-31` };
        }

        // --- CALCULATE GLOBAL STATS ---
        async function calculateSummaryStats(filterStorageId = null) {
            const now = new Date();
            const mRange = getCurrentMonthRange();
            const yRange = getYearRange(now.getFullYear());

            let qMonth = supabase.from('keuangan').select('saldo, transaksi').gte('tanggal', mRange.start).lte('tanggal', mRange.end);
            let qYear = supabase.from('keuangan').select('saldo, transaksi').gte('tanggal', yRange.start).lte('tanggal', yRange.end);

            if (filterStorageId) {
                qMonth = qMonth.eq('id_sim', filterStorageId);
                qYear = qYear.eq('id_sim', filterStorageId);
            }

            const resMonth = await qMonth;
            const resYear = await qYear;

            let mIn = 0, mOut = 0, yIn = 0, yOut = 0;

            if (resMonth.data) {
                resMonth.data.forEach(t => {
                    if (t.transaksi === 'Pemasukan') mIn += t.saldo;
                    else if (t.transaksi === 'Pengeluaran') mOut += t.saldo; 
                });
            }
            if (resYear.data) {
                resYear.data.forEach(t => {
                    if (t.transaksi === 'Pemasukan') yIn += t.saldo;
                    else if (t.transaksi === 'Pengeluaran') yOut += t.saldo; 
                });
            }

            summaryStats = { mIn, mOut, yIn, yOut };
            return summaryStats;
        }

        function renderSummaryText(containerId, stats) {
            const el = document.getElementById(containerId);
            el.innerHTML = `
                <div class="columns is-mobile is-multiline">
                    <div class="column is-6">
                        <p class="has-text-grey-light is-size-12">Bulan Ini</p>
                        <p class="has-text-success-custom is-size-12 font-weight-bold">Masuk: ${formatRupiah(stats.mIn)}</p>
                        <p class="has-text-danger-custom is-size-12 font-weight-bold">Keluar: ${formatRupiah(stats.mOut)}</p>
                    </div>
                    <div class="column is-6">
                        <p class="has-text-grey-light is-size-12">Tahun Ini</p>
                        <p class="has-text-success-custom is-size-12 font-weight-bold">Masuk: ${formatRupiah(stats.yIn)}</p>
                        <p class="has-text-danger-custom is-size-12 font-weight-bold">Keluar: ${formatRupiah(stats.yOut)}</p>
                    </div>
                </div>
            `;
        }

        // --- 6. PAGE LOGIC: DASHBOARD & CAROUSEL ---
        async function loadDashboard() {
            const range = getCurrentMonthRange();

            const { data: trxData, error } = await supabase
                .from('keuangan')
                .select('*')
                .gte('tanggal', range.start)
                .lte('tanggal', range.end);

            if (error) { console.error(error); return; }

            let income = 0;
            let expense = 0;
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const chartLabels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const chartDataIncome = new Array(daysInMonth).fill(0);
            const chartDataExpense = new Array(daysInMonth).fill(0);

            trxData.forEach(trx => {
                const day = new Date(trx.tanggal).getDate();
                if (day >= 1 && day <= daysInMonth) {
                    if (trx.transaksi === 'Pemasukan') {
                        income += trx.saldo;
                        chartDataIncome[day - 1] += trx.saldo;
                    } else if (trx.transaksi === 'Pengeluaran') {
                        expense += trx.saldo;
                        chartDataExpense[day - 1] += trx.saldo;
                    }
                }
            });

            document.getElementById('dash-pemasukan').innerText = formatRupiah(income);
            document.getElementById('dash-pengeluaran').innerText = formatRupiah(expense);

            const { data: storeData } = await supabase.from('penyimpanan').select('*');
            const { data: allTrx } = await supabase.from('keuangan').select('id_sim, saldo, transaksi');

            let grandTotal = 0;
            cachedStorageBalances = {}; // Reset global cache
            storeData.forEach(s => cachedStorageBalances[s.id_sim] = { name: s.namasim, balance: 0 });

            if (allTrx) {
                allTrx.forEach(t => {
                    if (cachedStorageBalances[t.id_sim]) {
                        if (t.transaksi === 'Pemasukan') cachedStorageBalances[t.id_sim].balance += t.saldo;
                        else cachedStorageBalances[t.id_sim].balance -= t.saldo;
                    }
                });
            }

            for (const [id, store] of Object.entries(cachedStorageBalances)) {
                grandTotal += store.balance;
            }

            document.getElementById('dash-total-uang').innerText = formatRupiah(grandTotal);
            renderChart(chartLabels, chartDataIncome, chartDataExpense);
            
            // Initialize Carousel with Data
            initDashboardCarousel();
        }

        // --- CAROUSEL LOGIC ---
        function initDashboardCarousel() {
            const track = document.getElementById('dash-storage-track');
            const dotsContainer = document.getElementById('carousel-dots');
            const width = window.innerWidth;
            
            let itemsPerSlide = 8;
            if (width < 769) itemsPerSlide = 4;
            else if (width < 1024) itemsPerSlide = 6;

            const storageIds = Object.keys(cachedStorageBalances);
            const totalItems = storageIds.length;
            const totalSlides = Math.ceil(totalItems / itemsPerSlide);

            let slidesHTML = '';
            for (let i = 0; i < totalSlides; i++) {
                let chunk = storageIds.slice(i * itemsPerSlide, (i + 1) * itemsPerSlide);
                
                let gridHTML = `<div class="columns is-multiline is-mobile mt-1">`;
                
                chunk.forEach(id => {
                    const store = cachedStorageBalances[id];
                    gridHTML += `
                        <div class="column is-3-desktop is-6-tablet is-12-mobile">
                            <div class="card p-3 h-100" style="height: 100%;">
                                <p class="is-size-7 has-text-grey-light">Penyimpanan</p>
                                <p class="has-text-weight-bold is-size-5 mb-1 is-truncated">${store.name}</p>
                                <p class="has-text-info font-weight-bold">${formatRupiah(store.balance)}</p>
                            </div>
                        </div>
                    `;
                });
                
                gridHTML += `</div>`;
                slidesHTML += `<div class="carousel-slide">${gridHTML}</div>`;
            }

            track.innerHTML = slidesHTML;
            
            let dotsHTML = '';
            for(let i=0; i<totalSlides; i++) {
                dotsHTML += `<div class="dot ${i===0?'is-active':''}" onclick="goToSlide(${i})"></div>`;
            }
            dotsContainer.innerHTML = dotsHTML;

            currentSlide = 0;
            updateCarouselView();
            updateCarouselControls(totalSlides);
        }

        function updateCarouselView() {
            const track = document.getElementById('dash-storage-track');
            track.style.transform = `translateX(-${currentSlide * 100}%)`;
            
            const dots = document.querySelectorAll('#carousel-dots .dot');
            dots.forEach((d, index) => {
                if(index === currentSlide) d.classList.add('is-active');
                else d.classList.remove('is-active');
            });
        }

        function nextSlide() {
            const track = document.getElementById('dash-storage-track');
            const totalSlides = track.children.length;
            if (currentSlide < totalSlides - 1) {
                currentSlide++;
                updateCarouselView();
                updateCarouselControls(totalSlides);
            }
        }

        function prevSlide() {
            if (currentSlide > 0) {
                currentSlide--;
                updateCarouselView();
                updateCarouselControls(document.getElementById('dash-storage-track').children.length);
            }
        }

        function goToSlide(index) {
            currentSlide = index;
            updateCarouselView();
            updateCarouselControls(document.getElementById('dash-storage-track').children.length);
        }

        function updateCarouselControls(total) {
            const prevBtn = document.getElementById('dash-prev-btn');
            const nextBtn = document.getElementById('dash-next-btn');
            
            if (prevBtn) prevBtn.disabled = currentSlide === 0;
            if (nextBtn) nextBtn.disabled = currentSlide === total - 1;
            
            // Optional: Hide buttons if only 1 slide exists
            if(total <= 1) {
               if(prevBtn) prevBtn.parentElement.style.display = 'none';
            } else {
               if(prevBtn) prevBtn.parentElement.style.display = 'grid';
            }
        }

        // --- CHART & COLORS ---
        function renderChart(labels, incomeData, expenseData) {
            const ctx = document.getElementById('financeChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            const isDark = document.body.classList.contains('dark-mode');
            const gridColor = isDark ? '#1e3a5f' : '#f0f0f0';
            const textColor = isDark ? '#d0efff' : '#666';

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Pemasukan',
                            data: incomeData,
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Pengeluaran',
                            data: expenseData,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: 100000,
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        x: {
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: textColor } }
                    }
                }
            });
        }

        function updateChartColors() {
            if (document.getElementById('page-dashboard').classList.contains('is-hidden')) return;
            loadDashboard();
        }

        // --- 7. PAGE LOGIC: CATATAN (TRANSACTIONS) ---
        async function loadCatatan() {
            const { data: stores } = await supabase.from('penyimpanan').select('*');
            storageMap = {};
            const select = document.getElementById('trx-storage');
            select.innerHTML = '<option value="" disabled selected>Pilih Penyimpanan</option>';
            if (stores) {
                stores.forEach(s => {
                    storageMap[s.id_sim] = s.namasim;
                    select.innerHTML += `<option value="${s.id_sim}">${s.namasim}</option>`;
                });
            }
            activeFilter = { type: 'currentMonth' };
            document.getElementById('table-period-label').innerText = "Data Bulan Ini";
            fetchTransactions();
        }

        async function fetchTransactions() {
            const stats = await calculateSummaryStats(null);
            renderSummaryText('summary-stats-catatan', stats);

            let query = supabase.from('keuangan').select('*');

            if (activeFilter.type === 'currentMonth') {
                const range = getCurrentMonthRange();
                query = query.gte('tanggal', range.start).lte('tanggal', range.end);
            } else if (activeFilter.type === 'range') {
                query = query.gte('tanggal', activeFilter.start).lte('tanggal', activeFilter.end);
            } else if (activeFilter.type === 'monthly') {
                const range = getMonthDateRange(activeFilter.year, activeFilter.month);
                query = query.gte('tanggal', range.start).lte('tanggal', range.end);
            } else if (activeFilter.type === 'yearly') {
                const range = getYearRange(activeFilter.year);
                query = query.gte('tanggal', range.start).lte('tanggal', range.end);
            }

            const { data, error } = await query.order('tanggal', { ascending: false });

            if (error) { Toast.fire({ icon: 'error', title: 'Gagal memuat data' }); return; }

            const tbody = document.getElementById('tbody-keuangan');
            tbody.innerHTML = '';

            if (data && data.length > 0) {
                data.forEach(row => {
                    let badgeClass = '';
                    let textClass = '';
                    let trxLabel = row.transaksi;

                    if (row.transaksi === 'Pemasukan') {
                        badgeClass = 'is-success';
                        textClass = 'has-text-success-custom';
                    } else if (row.transaksi === 'Pengeluaran') {
                        badgeClass = 'is-danger';
                        textClass = 'has-text-danger-custom';
                    } else if (row.transaksi === 'Transfer') {
                        badgeClass = 'is-info'; 
                        textClass = 'has-text-info-custom'; 
                    }
                    
                    const storageName = storageMap[row.id_sim] || 'Tidak Diketahui';

                    tbody.innerHTML += `
                        <tr>
                            <td data-date="${row.tanggal}">${formatDate(row.tanggal)}</td>
                            <td>${storageName}</td>
                            <td><span class="tag ${badgeClass} is-light">${trxLabel}</span></td>
                            <td class="col-desc">${row.deskripsi}</td>
                            <td class="has-text-right font-weight-bold ${textClass}">${formatRupiah(row.saldo)}</td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="has-text-centered has-text-grey">Belum ada data untuk periode ini</td></tr>';
            }
        }

        async function handleTransactionSubmit(e) {
            e.preventDefault();
            const date = document.getElementById('trx-date').value;
            const storageId = document.getElementById('trx-storage').value;
            const type = document.getElementById('trx-type-input').value;
            const amount = unformatRupiah(document.getElementById('trx-amount').value);
            const desc = document.getElementById('trx-desc').value;

            if (!amount || amount <= 0) return Toast.fire({ icon: 'warning', title: 'Nominal tidak valid' });

            const { error } = await supabase.from('keuangan').insert([{
                id_sim: storageId,
                tanggal: date,
                transaksi: type,
                saldo: amount,
                deskripsi: desc
            }]);

            if (error) {
                Toast.fire({ icon: 'error', title: error.message });
            } else {
                Toast.fire({ icon: 'success', title: 'Data Berhasil Ditambah' });
                resetForm('form-transaksi');
                fetchTransactions();
            }
        }

        function resetForm(formId) {
            document.getElementById(formId).reset();
            const today = new Date().toISOString().split('T')[0];
            if (formId === 'form-transaksi') {
                document.getElementById('trx-date').value = today;
                setTrxType('Pemasukan');
            }
            if (formId === 'form-transfer') document.getElementById('trf-date').value = today;
        }

        async function deleteLastTransaction() {
            const { data, error } = await supabase.from('keuangan').select('id_keung').order('id_keung', { ascending: false }).limit(1);
            if (data && data.length > 0) {
                const idToDelete = data[0].id_keung;
                const { error: delError } = await supabase.from('keuangan').delete().eq('id_keung', idToDelete);
                if (!delError) {
                    Toast.fire({ icon: 'success', title: 'Baris Terakhir Dihapus' });
                    fetchTransactions();
                }
            } else {
                Toast.fire({ icon: 'info', title: 'Data kosong' });
            }
        }

        function deleteAllData() {
            Swal.fire({
                title: 'Hapus Semua Data?',
                text: "Semua data keuangan akan hilang permanen!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e74c3c',
                confirmButtonText: 'Ya, Hapus Semua!'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Yakin 100%?',
                        text: "Tindakan ini tidak bisa dibatalkan.",
                        icon: 'error',
                        showCancelButton: true,
                        confirmButtonText: 'HANCURKAN DATA'
                    }).then(async (res2) => {
                        if (res2.isConfirmed) {
                            const { error } = await supabase.from('keuangan').delete().neq('id_keung', 0);
                            if (!error) {
                                Toast.fire({ icon: 'success', title: 'Semua Data Terhapus' });
                                fetchTransactions();
                            } else {
                                Toast.fire({ icon: 'error', title: 'Gagal Menghapus' });
                            }
                        }
                    });
                }
            });
        }

        // --- 8. FILTERS & MODALS ---
        function openModal(id) { document.getElementById(id).classList.add('is-active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('is-active'); }

        function applyFilter(type) {
            if (type === 'range') {
                const start = document.getElementById('filter-start').value;
                const end = document.getElementById('filter-end').value;
                if (!start || !end) return Toast.fire({ icon: 'warning', title: 'Isi kedua tanggal' });
                activeFilter = { type: 'range', start, end };
                document.getElementById('table-period-label').innerText = `Rentang: ${start} s/d ${end}`;
                closeModal('modal-range');
            } else if (type === 'monthly') {
                const m = document.getElementById('filter-month-select').value;
                const y = document.getElementById('filter-month-year').value;
                if (!y) return Toast.fire({ icon: 'warning', title: 'Isi tahun' });
                activeFilter = { type: 'monthly', month: m, year: y };
                document.getElementById('table-period-label').innerText = `Periode: Bulan ${m}, ${y}`;
                closeModal('modal-monthly');
            } else if (type === 'yearly') {
                const y = document.getElementById('filter-year-input').value;
                if (!y) return Toast.fire({ icon: 'warning', title: 'Isi tahun' });
                activeFilter = { type: 'yearly', year: y };
                document.getElementById('table-period-label').innerText = `Periode: Tahun ${y}`;
                closeModal('modal-yearly');
            }

            if (!document.getElementById('page-catatan').classList.contains('is-hidden')) fetchTransactions();
            if (currentStorageTabId) fetchDetailStorage(currentStorageTabId);
        }

        // --- 9. PAGE LOGIC: PENYIMPANAN ---
        async function loadPenyimpanan() {
            const { data } = await supabase.from('penyimpanan').select('*').order('id_sim', { ascending: true });
            
            navStorageItems = data || [];
            
            // Re-populate map
            storageMap = {};
            if (navStorageItems) {
                navStorageItems.forEach(s => storageMap[s.id_sim] = s.namasim);
            }

            // Init Sidebar Carousel
            initStorageNavCarousel();

            if (currentStorageTabId === null) fetchStorageList();
            else fetchDetailStorage(currentStorageTabId);
        }

        function initStorageNavCarousel(preserveState = false) {
            const track = document.getElementById('nav-storage-track');
            const dotsContainer = document.getElementById('nav-carousel-dots');
            
            const itemsPerSlide = 5;
            const totalItems = navStorageItems.length;
            const totalSlides = Math.ceil(totalItems / itemsPerSlide);

            if (!preserveState) {
                currentNavSlide = 0;
            }
            if (currentNavSlide >= totalSlides) currentNavSlide = totalSlides > 0 ? totalSlides - 1 : 0;

            let slidesHTML = '';
            for (let i = 0; i < totalSlides; i++) {
                let chunk = navStorageItems.slice(i * itemsPerSlide, (i + 1) * itemsPerSlide);
                let listHTML = '';
                
                chunk.forEach(s => {
                    const isActive = currentStorageTabId == s.id_sim ? 'is-active' : '';
                    listHTML += `<a class="${isActive}" onclick="switchStorageTab('${s.id_sim}', '${s.namasim}')">${s.namasim}</a>`;
                });
                
                slidesHTML += `<div class="carousel-slide">${listHTML}</div>`;
            }

            track.innerHTML = slidesHTML;
            
            let dotsHTML = '';
            if (totalSlides > 1) {
                for(let i=0; i<totalSlides; i++) {
                    dotsHTML += `<div class="dot ${i===currentNavSlide?'is-active':''}" onclick="goToNavSlide(${i})"></div>`;
                }
            }
            dotsContainer.innerHTML = dotsHTML;

            updateNavCarouselView();
            updateNavCarouselControls(totalSlides);
        }

        function updateNavCarouselView() {
            const track = document.getElementById('nav-storage-track');
            track.style.transform = `translateX(-${currentNavSlide * 100}%)`;
            
            const dots = document.querySelectorAll('#nav-carousel-dots .dot');
            dots.forEach((d, index) => {
                if(index === currentNavSlide) d.classList.add('is-active');
                else d.classList.remove('is-active');
            });
        }

        function nextNavSlide() {
            const track = document.getElementById('nav-storage-track');
            const totalSlides = track.children.length;
            if (currentNavSlide < totalSlides - 1) {
                currentNavSlide++;
                updateNavCarouselView();
                updateNavCarouselControls(totalSlides);
            }
        }

        function prevNavSlide() {
            if (currentNavSlide > 0) {
                currentNavSlide--;
                updateNavCarouselView();
                updateNavCarouselControls(document.getElementById('nav-storage-track').children.length);
            }
        }

        function goToNavSlide(index) {
            currentNavSlide = index;
            updateNavCarouselView();
            updateNavCarouselControls(document.getElementById('nav-storage-track').children.length);
        }

        function updateNavCarouselControls(total) {
            const prevBtn = document.getElementById('nav-prev-btn');
            const nextBtn = document.getElementById('nav-next-btn');
            
            if (prevBtn) prevBtn.disabled = currentNavSlide === 0;
            if (nextBtn) nextBtn.disabled = currentNavSlide === total - 1;
            
            // Optional: Hide buttons if only 1 slide exists
            if(total <= 1) {
               if(prevBtn) prevBtn.parentElement.style.display = 'none';
            } else {
               if(prevBtn) prevBtn.parentElement.style.display = 'grid';
            }
        }

        async function fetchStorageList() {
            const { data: stores } = await supabase.from('penyimpanan').select('*');
            const { data: trxs } = await supabase.from('keuangan').select('id_sim, saldo, transaksi');

            const balances = {};
            if (stores) {
                stores.forEach(s => balances[s.id_sim] = 0);
            }

            if (trxs) {
                trxs.forEach(t => {
                    if (balances[t.id_sim] !== undefined) {
                        if (t.transaksi === 'Pemasukan') balances[t.id_sim] += t.saldo;
                        else balances[t.id_sim] -= t.saldo;
                    }
                });
            }

            const tbody = document.getElementById('tbody-penyimpanan-list');
            tbody.innerHTML = '';

            if (stores) {
                stores.forEach((s) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <button class="button is-small is-info is-light" onclick="openEditStorage('${s.id_sim}', '${s.namasim}')"><i class="ph ph-pencil"></i></button>
                            <button class="button is-small is-danger is-light" onclick="deleteStorage('${s.id_sim}')"><i class="ph ph-trash"></i></button>
                        </td>
                        <td>${s.namasim}</td>
                        <td class="has-text-right font-weight-bold">${formatRupiah(balances[s.id_sim])}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function switchStorageTab(id, name) {
            currentStorageTabId = id === 'all' ? null : id;
            currentStorageName = name || "";

            // Re-render carousel to update active class inside slides
            // PASS true to preserve current slide position
            initStorageNavCarousel(true); 
            
            // Also handle the static "All" button active state
            const allBtn = document.querySelector('#storage-tabs > a.is-active'); 
            // Reset main list active state if moving to a specific storage
            if (id !== 'all') {
               if(allBtn) allBtn.classList.remove('is-active');
            } else {
               const staticAll = document.querySelector('#storage-tabs > a');
               if(staticAll) staticAll.classList.add('is-active');
            }

            if (id === 'all') {
                document.getElementById('storage-view-all').classList.remove('is-hidden');
                document.getElementById('storage-view-detail').classList.add('is-hidden');
                loadPenyimpanan(); // Refresh list
            } else {
                document.getElementById('storage-view-all').classList.add('is-hidden');
                document.getElementById('storage-view-detail').classList.remove('is-hidden');
                document.getElementById('detail-storage-name').innerText = `Riwayat: ${name}`;

                activeFilter = { type: 'currentMonth' };
                fetchDetailStorage(id);
            }
        }

        async function fetchDetailStorage(idSim) {
            const stats = await calculateSummaryStats(idSim);
            renderSummaryText('summary-stats-storage', stats);

            const { data: allTimeTrx } = await supabase.from('keuangan').select('saldo, transaksi').eq('id_sim', idSim);
            let bal = 0;
            if (allTimeTrx) {
                allTimeTrx.forEach(t => {
                    if (t.transaksi === 'Pemasukan') bal += t.saldo;
                    else bal -= t.saldo;
                });
            }
            currentStorageBalance = bal;
            document.getElementById('detail-storage-balance').innerText = formatRupiah(bal);

            let query = supabase.from('keuangan').select('*').eq('id_sim', idSim);

            if (activeFilter.type === 'currentMonth') {
                const range = getCurrentMonthRange();
                query = query.gte('tanggal', range.start).lte('tanggal', range.end);
            } else if (activeFilter.type === 'range') {
                query = query.gte('tanggal', activeFilter.start).lte('tanggal', activeFilter.end);
            } else if (activeFilter.type === 'monthly') {
                const range = getMonthDateRange(activeFilter.year, activeFilter.month);
                query = query.gte('tanggal', range.start).lte('tanggal', range.end);
            } else if (activeFilter.type === 'yearly') {
                const range = getYearRange(activeFilter.year);
                query = query.gte('tanggal', range.start).lte('tanggal', range.end);
            }

            const { data, error } = await query.order('tanggal', { ascending: false });

            const tbody = document.getElementById('tbody-storage-detail');
            tbody.innerHTML = '';

            if (data && data.length > 0) {
                data.forEach(row => {
                    let badgeClass = '';
                    let textClass = '';
                    let trxLabel = row.transaksi;

                    if (row.transaksi === 'Pemasukan') {
                        badgeClass = 'is-success';
                        textClass = 'has-text-success-custom';
                    } else if (row.transaksi === 'Pengeluaran') {
                        badgeClass = 'is-danger';
                        textClass = 'has-text-danger-custom';
                    } else if (row.transaksi === 'Transfer') {
                        badgeClass = 'is-info';
                        textClass = 'has-text-info-custom';
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td data-date="${row.tanggal}">${formatDate(row.tanggal)}</td>
                            <td><span class="tag ${badgeClass} is-light">${trxLabel}</span></td>
                            <td class="col-desc">${row.deskripsi}</td>
                            <td class="has-text-right ${textClass}">${formatRupiah(row.saldo)}</td>
                        </tr>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="has-text-centered has-text-grey">Belum ada riwayat transaksi</td></tr>';
            }
        }

        async function saveNewStorage() {
            const name = document.getElementById('new-storage-name').value;
            if (!name) return;
            const { error } = await supabase.from('penyimpanan').insert([{ namasim: name }]);
            if (!error) {
                Toast.fire({ icon: 'success', title: 'Penyimpanan Ditambah' });
                closeModal('modal-add-storage');
                loadPenyimpanan();
            }
        }

        function openEditStorage(id, name) {
            document.getElementById('edit-storage-id').value = id;
            document.getElementById('edit-storage-name').value = name;
            openModal('modal-edit-storage');
        }

        async function saveEditStorage() {
            const id = document.getElementById('edit-storage-id').value;
            const name = document.getElementById('edit-storage-name').value;
            const { error } = await supabase.from('penyimpanan').update({ namasim: name }).eq('id_sim', id);
            if (!error) {
                Toast.fire({ icon: 'success', title: 'Berhasil diupdate' });
                closeModal('modal-edit-storage');
                loadPenyimpanan();
            }
        }

        async function deleteStorage(id) {
            Swal.fire({
                title: 'Hapus Penyimpanan?',
                text: "Data terkait akan ikut terhapus.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Ya, Hapus'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await supabase.from('keuangan').delete().eq('id_sim', id);
                    const { error } = await supabase.from('penyimpanan').delete().eq('id_sim', id);
                    if (!error) {
                        Toast.fire({ icon: 'success', title: 'Terhapus' });
                        loadPenyimpanan();
                    } else {
                        Toast.fire({ icon: 'error', title: 'Gagal Hapus' });
                    }
                }
            })
        }

        // --- 10. PAGE LOGIC: TRANSFER & VALIDATION ---
        async function loadTransfer() {
            const { data: stores } = await supabase.from('penyimpanan').select('*');
            const src = document.getElementById('trf-source');
            const dst = document.getElementById('trf-dest');

            src.innerHTML = '<option value="" disabled selected>Pilih Sumber</option>';
            dst.innerHTML = '<option value="" disabled selected>Pilih Tujuan</option>';

            if (stores) {
                stores.forEach(s => {
                    const opt = `<option value="${s.id_sim}">${s.namasim}</option>`;
                    src.innerHTML += opt;
                    dst.innerHTML += opt;
                });
            }
        }

        async function handleTransferSubmit(e) {
            e.preventDefault();
            const date = document.getElementById('trf-date').value;
            const srcId = document.getElementById('trf-source').value;
            const dstId = document.getElementById('trf-dest').value;
            const amount = unformatRupiah(document.getElementById('trf-amount').value);
            const descSrc = document.getElementById('trf-desc-source').value;
            const descDst = document.getElementById('trf-desc-dest').value;

            if (srcId === dstId) return Toast.fire({ icon: 'error', title: 'Sumber dan Tujuan sama' });
            if (amount <= 0) return Toast.fire({ icon: 'warning', title: 'Nominal salah' });

            const { data: trxSource } = await supabase.from('keuangan').select('saldo, transaksi').eq('id_sim', srcId);
            let currentSrcBalance = 0;
            if (trxSource) {
                trxSource.forEach(t => {
                    if (t.transaksi === 'Pemasukan') currentSrcBalance += t.saldo;
                    else currentSrcBalance -= t.saldo;
                });
            }

            if (currentSrcBalance < amount) {
                return Swal.fire({
                    icon: 'error',
                    title: 'Saldo Tidak Cukup!',
                    text: `Saldo saat ini: ${formatRupiah(currentSrcBalance)}. Tidak cukup untuk transfer ${formatRupiah(amount)}.`
                });
            }

            const op1 = await supabase.from('keuangan').insert([{
                id_sim: srcId, tanggal: date, transaksi: 'Transfer', saldo: amount, deskripsi: descSrc
            }]);

            if (op1.error) return Toast.fire({ icon: 'error', title: 'Gagal tahap 1: ' + op1.error.message });

            const op2 = await supabase.from('keuangan').insert([{
                id_sim: dstId, tanggal: date, transaksi: 'Pemasukan', saldo: amount, deskripsi: descDst
            }]);

            if (op2.error) {
                Toast.fire({ icon: 'error', title: 'Gagal tahap 2' });
            } else {
                Swal.fire({
                    icon: 'success',
                    title: 'Transfer Berhasil',
                    text: `Berhasil transfer Rp ${formatRupiah(amount)}`
                });
                resetForm('form-transfer');
            }
        }

        // --- 11. PDF DOWNLOAD & SORTING ---
        function sortData(dir, tableId) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            const isStorage = tableId === 'table-storage-detail';
            const btnAsc = document.getElementById(isStorage ? 'sort-asc-storage' : 'sort-asc-btn');
            const btnDesc = document.getElementById(isStorage ? 'sort-desc-storage' : 'sort-desc-btn');

            if (btnAsc) btnAsc.classList.remove('is-sort-active');
            if (btnDesc) btnDesc.classList.remove('is-sort-active');

            if (dir === 'asc' && btnAsc) btnAsc.classList.add('is-sort-active');
            else if (btnDesc) btnDesc.classList.add('is-sort-active');

            rows.sort((a, b) => {
                const dateA = new Date(a.cells[0].getAttribute('data-date'));
                const dateB = new Date(b.cells[0].getAttribute('data-date'));
                return dir === 'asc' ? dateA - dateB : dateB - dateA;
            });

            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        function downloadPDF(tableId, title = "Laporan Keuangan") {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });

            doc.text(title, 14, 15);
            doc.setFontSize(10);
            doc.text(`Dicetak pada: ${new Date().toLocaleString()}`, 14, 22);

            doc.text("Ringkasan:", 14, 30);
            doc.text(`Bulan Ini - Masuk: ${formatRupiah(summaryStats.mIn)}, Keluar: ${formatRupiah(summaryStats.mOut)}`, 14, 35);
            doc.text(`Tahun Ini - Masuk: ${formatRupiah(summaryStats.yIn)}, Keluar: ${formatRupiah(summaryStats.yOut)}`, 14, 40);

            doc.autoTable({
                html: '#' + tableId,
                startY: 45,
                theme: 'grid',
                styles: { fontSize: 8, cellWidth: 'wrap' },
                headStyles: { fillColor: [17, 103, 177] },
                columnStyles: {
                    3: { cellWidth: 80 }
                }
            });

            doc.save('Laporan_Keuangan.pdf');
        }

        function downloadStoragePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });

            doc.setFontSize(14);
            doc.text(`Laporan Penyimpanan: ${currentStorageName}`, 14, 15);
            doc.setFontSize(10);
            doc.text(`Dicetak pada: ${new Date().toLocaleString()}`, 14, 22);

            doc.setFontSize(12);
            doc.setTextColor(17, 103, 177);
            doc.text(`Total Saldo Saat Ini: ${formatRupiah(currentStorageBalance)}`, 14, 32);
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);

            doc.text(`Bulan Ini - Masuk: ${formatRupiah(summaryStats.mIn)}, Keluar: ${formatRupiah(summaryStats.mOut)}`, 14, 40);
            doc.text(`Tahun Ini - Masuk: ${formatRupiah(summaryStats.yIn)}, Keluar: ${formatRupiah(summaryStats.yOut)}`, 14, 45);

            doc.autoTable({
                html: '#table-storage-detail',
                startY: 50,
                theme: 'grid',
                styles: { fontSize: 8, cellWidth: 'wrap' },
                headStyles: { fillColor: [17, 103, 177] },
                columnStyles: {
                    2: { cellWidth: 80 }
                }
            });

            doc.save(`Laporan_${currentStorageName}.pdf`);
        }

        function downloadChartPDF() {
            const canvas = document.getElementById('financeChart');
            const canvasImg = canvas.toDataURL("image/png", 1.0);
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');

            doc.setFontSize(14);
            doc.text("Analisa Keuangan (Grafik)", 14, 15);
            doc.addImage(canvasImg, 'PNG', 15, 20, 260, 120);
            doc.save('Grafik_Keuangan.pdf');
        }

    </script>

</body>
</html>
